name: Deploy to EC2
on:
  push:
    branches: [ main, develop ]
jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    # SSHë¡œ ì„œë²„ ì ‘ì† ë° ë°°í¬
    - name: Deploy to server
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.PRIVATE_KEY }}
        port: ${{ secrets.PORT }}
        debug: true
        script: |
          set -e  # ì—ëŸ¬ ë°œìƒì‹œ ìŠ¤í¬ë¦½íŠ¸ ì¤‘ë‹¨
          
          echo "ğŸš€ Starting deployment..."
          
          # í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ë¡œ ì´ë™
          cd ~/TalkBaro
          
          # ìµœì‹  ì½”ë“œ pull
          git pull origin develop
          
          # DB ë° ì¸í”„ë¼ ì„œë¹„ìŠ¤ ë¨¼ì € ì‹¤í–‰ (ì´ë¯¸ ì‹¤í–‰ ì¤‘ì´ë©´ ê·¸ëŒ€ë¡œ ìœ ì§€)
          docker compose up -d mysql mongodb kafka zookeeper
          
          # ë³€ê²½ì‚¬í•­ í™•ì¸ ë° í•„ìš”í•œ ì„œë¹„ìŠ¤ë§Œ ì¬ë¹Œë“œ
          echo "ğŸ” Checking for changes..."
          CHANGED_FILES=$(git diff HEAD~1 --name-only)
          
          if echo "$CHANGED_FILES" | grep -q "frontend/"; then
            echo "ğŸ¨ Frontend changes detected - rebuilding frontend..."
            docker compose up -d --build frontend
          fi
          
          if echo "$CHANGED_FILES" | grep -q "backend/"; then
            echo "âš¡ Backend changes detected - rebuilding backend..."
            docker compose up -d --build backend
          fi
          
          if echo "$CHANGED_FILES" | grep -q "nginx/"; then
            echo "ğŸŒ Nginx config changes detected - restarting nginx..."
            docker compose up -d nginx
          fi
          
          # ë³€ê²½ì‚¬í•­ì´ ì—†ê±°ë‚˜ ê¸°íƒ€ íŒŒì¼ ë³€ê²½ì‹œ ì „ì²´ ì• í”Œë¦¬ì¼€ì´ì…˜ ì¬ì‹œì‘
          if ! echo "$CHANGED_FILES" | grep -qE "(frontend/|backend/|nginx/)"; then
            echo "ğŸ“¦ Other changes detected - rebuilding all application services..."
            docker compose up -d --build backend frontend nginx
          fi
          
          # ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” ì´ë¯¸ì§€ ì •ë¦¬
          docker image prune -f

    # ë°°í¬ ì„±ê³µ ì•Œë¦¼
    - name: Deployment Success
      if: success()
      run: |
        echo "âœ… Deployment to EC2 completed successfully!"

    # ë°°í¬ ì‹¤íŒ¨ ì•Œë¦¼ ë° ë¡œê·¸
    - name: Deployment Failed
      if: failure()
      run: |
        echo "âŒ Deployment failed!"
        echo "Please check the logs above for error details"
        exit 1
